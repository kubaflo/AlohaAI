<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AlohaAI.ViewModels"
             x:Class="AlohaAI.Views.SearchPage"
             x:DataType="vm:SearchViewModel"
             Title="Search"
             Shell.NavBarIsVisible="False">
    <Grid>
        <!-- Layer 0: Sunset Gradient Background -->
        <BoxView InputTransparent="True">
            <BoxView.Background>
                <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                    <GradientStop Color="#0E0A1A" Offset="0.0" />
                    <GradientStop Color="#1A0F33" Offset="0.3" />
                    <GradientStop Color="#2D1B69" Offset="0.55" />
                    <GradientStop Color="#5B4A8C" Offset="0.75" />
                    <GradientStop Color="#8B5A7C" Offset="0.88" />
                    <GradientStop Color="#D97B6B" Offset="1.0" />
                </LinearGradientBrush>
            </BoxView.Background>
        </BoxView>

        <!-- Ambient Orb -->
        <Border HorizontalOptions="Center" VerticalOptions="End"
                TranslationY="-80"
                HeightRequest="300" WidthRequest="300"
                StrokeThickness="0" Stroke="Transparent" InputTransparent="True">
            <Border.StrokeShape><RoundRectangle CornerRadius="150" /></Border.StrokeShape>
            <Border.Background>
                <RadialGradientBrush Center="0.5,0.5" Radius="0.5">
                    <GradientStop Color="#357B68AE" Offset="0" />
                    <GradientStop Color="#107B68AE" Offset="0.6" />
                    <GradientStop Color="Transparent" Offset="1" />
                </RadialGradientBrush>
            </Border.Background>
        </Border>

    <ScrollView>
    <VerticalStackLayout Padding="20" Spacing="16">
        <!-- Header -->
        <Label Text="Search" FontSize="28" FontAttributes="Bold" TextColor="White" Margin="0,50,0,0" />

        <!-- Search Bar -->
        <Border StrokeShape="RoundRectangle 16" Padding="4,0">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#30FFFFFF" Offset="0.0" />
                    <GradientStop Color="#10FFFFFF" Offset="1.0" />
                </LinearGradientBrush>
            </Border.Background>
            <Border.Stroke>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#40FFFFFF" Offset="0.0" />
                    <GradientStop Color="#10FFFFFF" Offset="1.0" />
                </LinearGradientBrush>
            </Border.Stroke>
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                <Image Source="icon_explore.png" WidthRequest="20" HeightRequest="20"
                       VerticalOptions="Center" Margin="12,0,0,0" />
                <Entry Grid.Column="1"
                       Placeholder="Search lessons..."
                       Text="{Binding SearchQuery}"
                       FontSize="16"
                       PlaceholderColor="{StaticResource Gray400}"
                       TextColor="White"
                       ReturnType="Search" />
                <Button Grid.Column="2"
                        Text="✕"
                        IsVisible="{Binding HasResults}"
                        Command="{Binding ClearCommand}"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Gray400}"
                        FontSize="16"
                        Padding="8"
                        WidthRequest="44" />
            </Grid>
        </Border>

        <!-- Filter Chips -->
        <HorizontalStackLayout Spacing="8">
            <Border BackgroundColor="{Binding AllFilterBackground}"
                    StrokeShape="RoundRectangle 16" Stroke="{Binding AllFilterStroke}" StrokeThickness="1"
                    Padding="14,8">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="" />
                </Border.GestureRecognizers>
                <Label Text="All" FontSize="13" TextColor="{Binding AllFilterText}" />
            </Border>
            <CollectionView ItemsSource="{Binding FilterChips}" SelectionMode="None"
                            ItemsLayout="HorizontalList" HeightRequest="40">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:FilterChipItem">
                        <Border BackgroundColor="{Binding Background}"
                                StrokeShape="RoundRectangle 16" Stroke="{Binding StrokeColor}" StrokeThickness="1"
                                Padding="14,8" Margin="0,0,8,0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SearchViewModel}}, Path=FilterCommand}"
                                    CommandParameter="{Binding PathId}" />
                            </Border.GestureRecognizers>
                            <Label Text="{Binding Title}" FontSize="13" TextColor="{Binding TextColor}" />
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </HorizontalStackLayout>

        <!-- Results -->
        <CollectionView ItemsSource="{Binding Results}" SelectionMode="None" IsVisible="{Binding HasResults}">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:SearchResultItem">
                    <Border Style="{StaticResource GlassCard}" Padding="16">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SearchViewModel}}, Path=SelectResultCommand}"
                                CommandParameter="{Binding .}" />
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                            <Border BackgroundColor="{Binding PathColor}"
                                    StrokeShape="RoundRectangle 10"
                                    Stroke="Transparent"
                                    WidthRequest="36" HeightRequest="36">
                                <Border.Shadow>
                                    <Shadow Brush="{Binding PathColor}" Offset="0,2" Radius="8" Opacity="0.4" />
                                </Border.Shadow>
                                <Image Source="icon_notebook.png" WidthRequest="20" HeightRequest="20"
                                       HorizontalOptions="Center" VerticalOptions="Center" />
                            </Border>
                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                <Label Text="{Binding LessonTitle}" FontSize="15" FontAttributes="Bold"
                                       TextColor="White" MaxLines="1" LineBreakMode="TailTruncation" />
                                <Label Text="{Binding Subtitle}" FontSize="12" TextColor="{StaticResource Gray400}"
                                       MaxLines="1" LineBreakMode="TailTruncation" />
                            </VerticalStackLayout>
                            <Label Grid.Column="2" Text="{Binding Xp, StringFormat='+{0} XP'}"
                                   FontSize="12" TextColor="{StaticResource XPColor}" VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Empty State -->
        <VerticalStackLayout IsVisible="{Binding ShowEmpty}" Spacing="8" VerticalOptions="Center" HorizontalOptions="Center" Margin="0,40,0,0">
            <Image Source="icon_explore.png" WidthRequest="48" HeightRequest="48" HorizontalOptions="Center" Opacity="0.5" />
            <Label Text="No results found" FontSize="18" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center" />
            <Label Text="Try a different search term" FontSize="14" TextColor="{StaticResource Gray400}" HorizontalOptions="Center" />
        </VerticalStackLayout>

        <!-- Browse by Topic (when no search) -->
        <VerticalStackLayout IsVisible="{Binding ShowBrowse}" Spacing="12" Margin="0,8,0,0">
            <Label Text="Browse Topics" FontSize="18" FontAttributes="Bold" TextColor="White" />
            <CollectionView ItemsSource="{Binding BrowseItems}" SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:BrowseTopicItem">
                        <Border Style="{StaticResource GlassCard}" Padding="16">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SearchViewModel}}, Path=BrowseTopicCommand}"
                                    CommandParameter="{Binding PathId}" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <Border BackgroundColor="{Binding Color}"
                                        StrokeShape="RoundRectangle 10" Stroke="Transparent"
                                        WidthRequest="40" HeightRequest="40">
                                    <Border.Shadow>
                                        <Shadow Brush="{Binding Color}" Offset="0,4" Radius="10" Opacity="0.4" />
                                    </Border.Shadow>
                                    <Image Source="{Binding Icon}" WidthRequest="28" HeightRequest="28"
                                           HorizontalOptions="Center" VerticalOptions="Center" />
                                </Border>
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                    <Label Text="{Binding Title}" FontSize="15" FontAttributes="Bold" TextColor="White" />
                                    <Label Text="{Binding LessonCount, StringFormat='{0} lessons'}" FontSize="12"
                                           TextColor="{StaticResource Gray300}" />
                                </VerticalStackLayout>
                                <Label Grid.Column="2" Text="→" FontSize="16" TextColor="{StaticResource Gray400}" VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </VerticalStackLayout>
    </ScrollView>
    </Grid>
</ContentPage>
