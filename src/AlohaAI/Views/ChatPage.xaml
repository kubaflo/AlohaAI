<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AlohaAI.ViewModels"
             x:Class="AlohaAI.Views.ChatPage"
             x:DataType="vm:ChatViewModel"
             Title="Chat"
             Shell.NavBarIsVisible="False"
             Shell.NavBarVisibilityAnimationEnabled="False"
             BackgroundColor="#120C24"
             SafeAreaEdges="None">
    <Grid Margin="0,-60,0,0" SafeAreaEdges="None">
        <BoxView InputTransparent="True">
            <BoxView.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#1E1035" Offset="0.0" />
                    <GradientStop Color="#120C24" Offset="1.0" />
                </LinearGradientBrush>
            </BoxView.Background>
        </BoxView>
        <Grid HeightRequest="260" VerticalOptions="Start" InputTransparent="True">
            <Image Source="bg_sunset.png" Aspect="AspectFill" />
            <BoxView>
                <BoxView.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#00000000" Offset="0.0" />
                        <GradientStop Color="#901E1035" Offset="0.5" />
                        <GradientStop Color="#FF120C24" Offset="1.0" />
                    </LinearGradientBrush>
                </BoxView.Background>
            </BoxView>
        </Grid>
        
        <!-- Layer 2: Main Content -->
        <Grid RowDefinitions="Auto,*,Auto" Padding="0" SafeAreaEdges="None">
            
            <!-- Header Area -->
            <VerticalStackLayout Grid.Row="0" Padding="24,0,24,20" Spacing="8">
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                        <Label Text="Aloha AI" 
                               FontSize="28" 
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalOptions="Center">
                            <Label.Shadow>
                                <Shadow Brush="#40000000" Offset="0,2" Radius="6" Opacity="0.5" />
                            </Label.Shadow>
                        </Label>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            
            <!-- Chat Content Area -->
            <Grid Grid.Row="1">
                <!-- Empty State (no messages yet) -->
                <VerticalStackLayout IsVisible="{Binding HasMessages, Converter={StaticResource InverseBoolConverter}}"
                                     VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Spacing="16"
                                     Padding="40">
                    <!-- Greeting -->
                    <Label Text="{Binding UserName, StringFormat='Hello, {0}'}"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center">
                        <Label.Shadow>
                            <Shadow Brush="#40000000" Offset="0,2" Radius="4" Opacity="0.4" />
                        </Label.Shadow>
                    </Label>
                    
                    <Label Text="How can I help you?"
                           FontSize="17"
                           TextColor="#CCFFFFFF"
                           HorizontalOptions="Center" />
                    
                    <!-- Microphone Button -->
                    <Border StrokeShape="RoundRectangle 40"
                            Stroke="Transparent"
                            WidthRequest="80"
                            HeightRequest="80"
                            HorizontalOptions="Center"
                            Margin="0,30,0,0">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#FF6B35" Offset="0.0" />
                                <GradientStop Color="#FF8F5C" Offset="0.5" />
                                <GradientStop Color="#FFB088" Offset="1.0" />
                            </LinearGradientBrush>
                        </Border.Background>
                        <Border.Shadow>
                            <Shadow Brush="#FF6B35" Offset="0,6" Radius="24" Opacity="0.7" />
                        </Border.Shadow>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding StartVoiceInputCommand}" />
                        </Border.GestureRecognizers>
                        <Image Source="icon_explore.png" 
                               WidthRequest="36" HeightRequest="36"
                               HorizontalOptions="Center" 
                               VerticalOptions="Center" />
                    </Border>
                    
                    <Label Text="Tap to speak"
                           FontSize="13"
                           TextColor="#AAFFFFFF"
                           HorizontalOptions="Center"
                           Margin="0,8,0,0" />
                </VerticalStackLayout>
                
                <!-- Messages List (when there are messages) -->
                <ScrollView IsVisible="{Binding HasMessages}" Padding="16,0" VerticalScrollBarVisibility="Never">
                    <VerticalStackLayout Spacing="12" 
                                         BindableLayout.ItemsSource="{Binding Messages}"
                                         Padding="0,0,0,20">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="vm:ChatMessage">
                                <Border Padding="16,12"
                                        StrokeShape="RoundRectangle 16"
                                        Stroke="Transparent"
                                        MaximumWidthRequest="300"
                                        BackgroundColor="{Binding IsUser, Converter={StaticResource UserMessageColorConverter}}"
                                        HorizontalOptions="{Binding IsUser, Converter={StaticResource BoolToHorizontalOptionsConverter}}">
                                    <Border.Shadow>
                                        <Shadow Brush="#000000" Offset="0,4" Radius="12" Opacity="0.3" />
                                    </Border.Shadow>
                                    <Label Text="{Binding Text}"
                                           FontSize="15"
                                           TextColor="White"
                                           LineBreakMode="WordWrap" />
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </ScrollView>
                
                <!-- Loading indicator -->
                <ActivityIndicator IsRunning="{Binding IsBusy}" 
                                   IsVisible="{Binding IsBusy}"
                                   HorizontalOptions="Center" 
                                   VerticalOptions="End"
                                   Color="{StaticResource Primary}"
                                   Margin="0,0,0,20" />
            </Grid>
            
            <!-- Input Area -->
            <Border Grid.Row="2" 
                    Margin="16,0,16,30"
                    Padding="4,4,4,4"
                    StrokeShape="RoundRectangle 25"
                    StrokeThickness="1">
                <Border.BackgroundColor>
                    <Color>#1A1035</Color>
                </Border.BackgroundColor>
                <Border.Stroke>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#40FFFFFF" Offset="0.0" />
                        <GradientStop Color="#10FFFFFF" Offset="1.0" />
                    </LinearGradientBrush>
                </Border.Stroke>
                <Border.Shadow>
                    <Shadow Brush="#000000" Offset="0,4" Radius="16" Opacity="0.4" />
                </Border.Shadow>
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Entry Grid.Column="0"
                           Placeholder="Ask Aloha AI anything..."
                           Text="{Binding UserMessage}"
                           FontSize="17"
                           PlaceholderColor="#80FFFFFF"
                           TextColor="White"
                           BackgroundColor="Transparent"
                           ReturnType="Send"
                           ReturnCommand="{Binding SendMessageCommand}"
                           Margin="16,0,0,0" />
                    <Border Grid.Column="1"
                            BackgroundColor="{StaticResource Primary}"
                            StrokeShape="RoundRectangle 20"
                            Stroke="Transparent"
                            WidthRequest="44"
                            HeightRequest="44"
                            Margin="4">
                        <Border.Shadow>
                            <Shadow Brush="{StaticResource Primary}" Offset="0,2" Radius="8" Opacity="0.5" />
                        </Border.Shadow>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SendMessageCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="âž¤" 
                               FontSize="18" 
                               TextColor="White"
                               HorizontalOptions="Center" 
                               VerticalOptions="Center" />
                    </Border>
                </Grid>
            </Border>
            
        </Grid>
    </Grid>
</ContentPage>
